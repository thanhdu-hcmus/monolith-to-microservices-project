version: 2.1

jobs:
  udagram-images:
    docker:
      - image: cimg/base:2024.09
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker images
          command: |
            # Define image tags and repositories
            TAG=1.0.$TAG_NUMBER
            IMAGES=("udagram-api-user" "udagram-api-feed" "udagram-frontend" "reverseproxy")

            # Build each Docker image in parallel (to save time)
            for image in "${IMAGES[@]}"; do
              echo "Building $image"
              docker build -t $image ./$image &
            done

            # Wait for all builds to finish
            wait

      - run:
          name: Tag Docker images
          command: |
            TAG=1.0.$TAG_NUMBER
            # Tag all images in a loop
            for image in "${IMAGES[@]}"; do
              echo "Tagging $image"
              docker tag $image $DOCKER_USERNAME/$image:$TAG
            done

      - run:
          name: Push Docker images
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            TAG=1.0.$TAG_NUMBER
            # Push all images in a loop
            for image in "${IMAGES[@]}"; do
              echo "Pushing $image"
              docker push $DOCKER_USERNAME/$image:$TAG
            done

workflows:
  version: 2
  udagram-workflow:
    jobs:
      - udagram-images
